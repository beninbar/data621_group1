---
title: 'Homework #4:  Multiple linear regression and Binary logistic regression'
subtitle: 'Critical Thinking Group 1'
author: 'Ben Inbar, Cliff Lee, Daria Dubovskaia, David Simbandumwe, Jeff Parks'
output:
  html_document:
    toc: yes
    toc_float: yes
    theme: united
  pdf_document:
    toc: yes
editor_options:
  chunk_output_type: console
  markdown: 
    wrap: sentence
---


```{r setup, include=FALSE}
library(mice)
library(readr)
library(skimr)
library(ggplot2)
library(tidyverse)
library(reshape2)
library(MASS)
library(forecast)


## To load the below libraries you might have to do the following in the console first:
####  install.packages("devtools")
####  devtools::install_github("haleyjeppson/ggmosaic")
####  devtools::install_github("thomasp85/patchwork")

library(ggmosaic)
library(patchwork)



knitr::opts_chunk$set(echo = FALSE)
```


```{r data}
# read train and evaluation datasets
train_df <- read.csv("https://raw.githubusercontent.com/cliftonleesps/data621_group1/main/hw4/insurance_training_data.csv")
eval_df <- read.csv("https://raw.githubusercontent.com/cliftonleesps/data621_group1/main/hw4/insurance-evaluation-data.csv")

```


## Overview

In this homework assignment, we will explore, analyze and model a data set containing approximately 8000 records representing a customer at an auto insurance company. We will build multiple linear regression on the continuous variable `TARGET_AMT` and binary logistic regression on the `TARGET_FLAG` using the training data to predict the probability that a person will crash their car and also the amount of money it will cost if the person does crash their car. 

We are going to build several models using different techniques and variable selection. In order to best assess our predictive model, we created a test set within our training data, and split it along an 80/20 training/testing proportion, before applying the finalized models to a separate evaluation dataset that did not contain the target.


## 1. Data Exploration

The insurance training dataset contains 8161 observations of 26 variables, each record represents a customer at an auto insurance company. The evaluation dataset contains 2141 observations of 26 variables.
The descriptions of each column are below.

Each record has two response variables. The first response variable, `TARGET_FLAG`, is a 1 or a 0. A “1” means that the person was in a car crash. A zero means that the person was not in a car crash. The second response variable is `TARGET_AMT`. This value is zero if the person did not crash their car. But if they did crash their car, this number will be a value greater than zero.


<img src="https://raw.githubusercontent.com/cliftonleesps/data621_group1/main/hw4/hw4_variables.png" width="1200" style="display: block; margin-left: auto; margin-right: auto; width: 100%;"/>

### 1.1 Summary Statistics

The training data can be previewed below. The `TARGET_FLAG` column is the binary dependent variable denoting if a car was in a crash (target = 1) or not (target = 0).
`TARGET_AMT` is a numeric dependent variable and represents the amount of time the car spent on repairs in case of crash. The minimum is 0 (car wasn't in crash, no time spent on repairs), the maximum is 107586.1. 
```{r summary1}
DT::datatable(
      train_df[1:500,],
      extensions = c('Scroller'),
      options = list(scrollY = 350,
                     scrollX = 500,
                     deferRender = TRUE,
                     scroller = TRUE,
                     dom = 'lBfrtip',
                     fixedColumns = TRUE, 
                     searching = FALSE), 
      rownames = FALSE) 
```

The table below provides valuable descriptive statistics about the training data. 14 variables are categorical, 12 variables are numeric.
There is no missing data for categorical variables while numeric variables `YOJ` (years on job) has 5% of missing data, `CAR_AGE` (vehicle age) has 6%, and `AGE` (age of driver) has less than 1%. 
Most of the numeric variables have a minimum of zero. Some numbers seem strange, we should deal with it later. For example, `CAR_AGE` has the minimum value of -3.
Some of the variables are character though they should be numeric and vice versa. Variable `OLDCLAIM`, `BLUEBOOK`, `HOME_VAL`, `INCOME` have $ sign in front a number, we should remove the sign and transform the variable to numeric. Variables `MSTATUS` (Marital Status), `EDUCATION`, `JOB`, `CAR_TYPE`, `SEX` AND `URBANICITY` contain prefix `z_` that should be removed as well.
**ADD SOMETHING ELSE FOR SUMMARY**

```{r summary}
skim(train_df)
```

```{r balance}
proportion <- colMeans(train_df['TARGET_FLAG'])
proportion
```

### 1.2 Distributions



### 1.3 Box Plots



### 1.4 Correlation Matrix



## 2. Data preparation

### 2.1 Data type
First, we will remove prefixes `z_` and `$` together with the `INDEX` variable (identification Variable), transform to factor variables `TARGET_FLAG`, `KIDSDRIV`, `HOMEKIDS`, `CLM_FREQ`, `MVR_PTS`. Also, we transform to numeric variables `INCOME`, `HOME_VAL`, `BLUEBOOK`, `OLDCLAIM`

```{r}
train_df <- train_df %>%  dplyr::select(-INDEX)

## Create CAR_CRASH variable from the target flag for later exploration
train_df <- train_df %>% mutate(CAR_CRASH = ifelse(TARGET_FLAG == 1, 'Yes', 'No'))


## Remove z_ from character class values
z_vars <- c("MSTATUS","SEX","JOB","CAR_TYPE","URBANICITY","EDUCATION")
for (v in z_vars) {
  train_df <- train_df %>% mutate(!!v := str_replace(get(v),"z_",""))
}

## Convert currency columns from character class to integer
dollar_vars <- c("INCOME","HOME_VAL","BLUEBOOK","OLDCLAIM")
for (v in dollar_vars) {
  train_df <- train_df %>% mutate(!!v := str_replace(get(v),"[\\$,]",""))
}

currency_vars <- c("INCOME","HOME_VAL","BLUEBOOK","OLDCLAIM")

for (v in currency_vars) {
  train_df <- train_df %>% mutate(!!v := parse_number(get(v)))
}


## Convert the below character variables to factors
factor_vars <- c("TARGET_FLAG", "KIDSDRIV","HOMEKIDS","CLM_FREQ", "MVR_PTS", "PARENT1","CAR_TYPE","JOB","CAR_USE","URBANICITY","RED_CAR","REVOKED","MSTATUS","EDUCATION","SEX")

for (v in factor_vars) {
  train_df <- train_df %>% mutate(!!v := factor(get(v)))
}
```


### 2.2 Missing values
```{r include=FALSE}




## Update RED_CAR, replace [no,yes] values with [No, Yes] values
train_df <- train_df %>% mutate( RED_CAR = ifelse(RED_CAR == "no","No","Yes"))


## We need to impute the AGE, YOJ, CAR_AGE, INCOME, HOME_VAL and CAR_AGE variables
imputed_Data <- mice(train_df, m=5, maxit = 20, method = 'pmm', seed = 500, printFlag=FALSE)
train_df <- complete(imputed_Data)


## We have one row with a car age < 0! just set it to zero. Assume it's a brand new car
### train_df <- rows_update(train_df, tibble(INDEX = 8772, CAR_AGE = 0))


## Use basic log transformation on INCOME
train_df$INCOME <- log(train_df$INCOME)

# use Box-Cox on TRAVTIME, BLUEBOOK
bluebook_boxcox <- boxcox(lm(train_df$BLUEBOOK ~ 1))
bluebook_lambda <- bluebook_boxcox$x[which.max(bluebook_boxcox$y)]
bluebook_trans <- BoxCox(train_df$BLUEBOOK, bluebook_lambda)
train_df$BLUEBOOK <- bluebook_trans

travtime_boxcox <- boxcox(lm(train_df$TRAVTIME ~ 1))
travtime_lambda <- travtime_boxcox$x[which.max(travtime_boxcox$y)]
travtime_trans <- BoxCox(train_df$TRAVTIME, travtime_lambda)
train_df$TRAVTIME <- travtime_trans

## Create CAR_CRASH variable from the target flag for later exploration
train_df <- train_df %>% mutate(CAR_CRASH = ifelse(TARGET_FLAG == 1, 'Yes', 'No'))

## put into bins:  TIF; CAR_AGE; HOMEKIDS; HOME_VAL
q <- quantile(train_df$CAR_AGE)
q <- c(-1,  1,  8, 12, 28)
train_df <- train_df %>% mutate(CAR_AGE_BIN = cut(CAR_AGE, breaks=q, labels=FALSE))

q <- quantile(train_df$HOME_VAL)
q[1] <- -1
train_df <- train_df %>% mutate(HOME_VAL_BIN = cut(HOME_VAL, breaks=q, labels=FALSE))

q <- quantile(train_df$TIF); 
q[1] <- -1
train_df <- train_df %>% mutate(TIF_BIN = cut(TIF, breaks=q, labels=FALSE))


print(summary(train_df))


```

### 2.3 Outliers

### 2.4 Visualizations

```{r visualizations}
colnames(train_df)

a <- train_df %>% select_if(is.numeric) %>% dplyr::select(!(c(TARGET_AMT))) %>% data.table::melt()
a %>% ggplot(aes(x=value))+ geom_density(alpha=.2,fill="#FF6666") + facet_wrap(~variable, scales='free')


## Mosaic plots to view any relationship to the TARGET_FLAG variable for binary factor variables
## PARENT1
plot_parent1 <- ggplot(data = train_df) +
  geom_mosaic(aes(x = PARENT1, fill=CAR_CRASH), offset = 0.005) +
  labs(y="", x="", title="Single Parent", margin=margin(b=10,unit="pt")) +
    theme(panel.background = element_blank(),
          axis.text.y = element_blank(),
          axis.ticks.y= element_blank(),
          axis.ticks.x= element_blank(),
          axis.text.x = element_text(angle = 0, margin = margin(t = -6, unit="mm")),
          plot.title = element_text(hjust = 0.5),
          axis.title.x = element_blank(),
          legend.position = "right")

## Sex
plot_sex <- ggplot(data = train_df) +
  geom_mosaic(aes(x = SEX, fill=CAR_CRASH), offset = 0.005) +
  labs(y="", x="", title="Sex", margin=margin(b=10,unit="pt")) +
    theme(panel.background = element_blank(),
          axis.text.y = element_blank(),
          axis.ticks.y= element_blank(),
          axis.ticks.x= element_blank(),
          axis.text.x = element_text(angle = 0, margin = margin(t = -6, unit="mm")),
          plot.title = element_text(hjust = 0.5),
          axis.title.x = element_blank(),
          legend.position = "right")

## Marriage status
plot_mstatus <- ggplot(data = train_df) +
  geom_mosaic(aes(x = MSTATUS, fill=CAR_CRASH), offset = 0.005) +
  labs(y="", x="", title="Marriage Status", margin=margin(b=10,unit="pt")) +
    theme(panel.background = element_blank(),
          axis.text.y = element_blank(),
          axis.ticks.y= element_blank(),
          axis.ticks.x= element_blank(),
          axis.text.x = element_text(angle = 0, margin = margin(t = -6, unit="mm")),
          plot.title = element_text(hjust = 0.5),
          axis.title.x = element_blank(),
          legend.position = "right")

## Car use
plot_car_use <- ggplot(data = train_df) +
  geom_mosaic(aes(x = CAR_USE, fill=CAR_CRASH), offset = 0.005) +
  labs(y="", x="", title="Car Use", margin=margin(b=10,unit="pt")) +
    theme(panel.background = element_blank(),
          axis.text.y = element_blank(),
          axis.ticks.y= element_blank(),
          axis.ticks.x= element_blank(),
          axis.text.x = element_text(angle = 0, margin = margin(t = -6, unit="mm")),
          plot.title = element_text(hjust = 0.5),
          axis.title.x = element_blank(),
          legend.position = "right")

## Red car
plot_red_car <- ggplot(data = train_df) +
  geom_mosaic(aes(x = RED_CAR, fill=CAR_CRASH), offset = 0.005) +
  labs(y="", x="", title="Red Car?", margin=margin(b=10,unit="pt")) +
    theme(panel.background = element_blank(),
          axis.text.y = element_blank(),
          axis.ticks.y= element_blank(),
          axis.ticks.x= element_blank(),
          axis.text.x = element_text(angle = 0, margin = margin(t = -6, unit="mm")),
          plot.title = element_text(hjust = 0.5),
          axis.title.x = element_blank(),
          legend.position = "right")

## license revoked
plot_revoked <- ggplot(data = train_df) +
  geom_mosaic(aes(x = REVOKED, fill=CAR_CRASH), offset = 0.005) +
  labs(y="", x="", title="License Revoked (Past 7 Years)", margin=margin(b=10,unit="pt")) +
    theme(panel.background = element_blank(),
          axis.text.y = element_blank(),
          axis.ticks.y= element_blank(),
          axis.ticks.x= element_blank(),
          axis.text.x = element_text(angle = 0, margin = margin(t = -6, unit="mm")),
          plot.title = element_text(hjust = 0.5),
          axis.title.x = element_blank(),
          legend.position = "right")

## urban or rural area
plot_urbanicity <- ggplot(data = train_df) +
  geom_mosaic(aes(x = URBANICITY, fill=CAR_CRASH), offset = 0.005) +
  labs(y="", x="", title="Home / Work Area", margin=margin(b=10,unit="pt")) +
    theme(panel.background = element_blank(),
          axis.text.y = element_blank(),
          axis.ticks.y= element_blank(),
          axis.ticks.x= element_blank(),
          axis.text.x = element_text(angle = 0, margin = margin(t = -6, unit="mm")),
          plot.title = element_text(hjust = 0.5),
          axis.title.x = element_blank(),
          legend.position = "right")

plot_parent1 + plot_sex + plot_mstatus + plot_car_use + plot_red_car + plot_revoked + plot_urbanicity + plot_layout(nrow = 4)


## Mosaic plots to view any relationship to the TARGET_FLAG variable for multi-level factors 
plot_education <- ggplot(data = train_df) +
  geom_mosaic(aes(x = EDUCATION, fill=CAR_CRASH), offset = 0.005) +
  labs(y="", x="", title="Education", margin=margin(b=10,unit="pt")) +
    theme(panel.background = element_blank(),
          axis.text.y = element_blank(),
          axis.ticks.y= element_blank(),
          axis.ticks.x= element_blank(),
          axis.text.x = element_text(angle = 90, margin = margin(t = -0.5, unit="pt")),
          plot.title = element_text(hjust = 0.5),
          axis.title.x = element_blank(),
          legend.position = "right")

plot_job <- ggplot(data = train_df) +
  geom_mosaic(aes(x = JOB, fill=CAR_CRASH), offset = 0.005) +
  labs(y="", x="", title="Job Category", margin=margin(b=10,unit="pt")) +
    theme(panel.background = element_blank(),
          axis.text.y = element_blank(),
          axis.ticks.y= element_blank(),
          axis.ticks.x= element_blank(),
          axis.text.x = element_text(angle = 90, margin = margin(t = -0.5, unit="pt")),
          plot.title = element_text(hjust = 0.5),
          axis.title.x = element_blank(),
          legend.position = "right")

plot_car_type <- ggplot(data = train_df) +
  geom_mosaic(aes(x = CAR_TYPE, fill=CAR_CRASH), offset = 0.005) +
  labs(y="", x="", title="Car Type", margin=margin(b=10,unit="pt")) +
    theme(panel.background = element_blank(),
          axis.text.y = element_blank(),
          axis.ticks.y= element_blank(),
          axis.ticks.x= element_blank(),
          axis.text.x = element_text(angle = 90, margin = margin(t = -0.5, unit="pt")),
          plot.title = element_text(hjust = 0.5),
          axis.title.x = element_blank(),
          legend.position = "right")


plot_education + plot_job + plot_car_type + plot_layout(nrow = 2)

```

## 3. Multiple linear regression


### 3.1 Model 1 - 


### 3.2 Model 2 - 


### 3.3 Model 3 - 

### 3.4 Model selection



## 4. Binary logistic regression


### 4.1 Model 1 - 


### 4.2 Model 2 - 


### 4.3 Model 3 - 

### 4.4 Model selection



## 5. Predictions


## 6. Conclusion



## 7. References


## Appendix: R code


