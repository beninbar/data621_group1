---
title: 'Homework #4:  Multiple linear regression and Binary logistic regression'
subtitle: 'Critical Thinking Group 1'
author: 'Ben Inbar, Cliff Lee, Daria Dubovskaia, David Simbandumwe, Jeff Parks'
output:
  html_document:
    toc: yes
    toc_float: yes
    theme: united
  pdf_document:
    toc: yes
editor_options:
  chunk_output_type: console
  markdown: 
    wrap: sentence
---


```{r setup, include=FALSE}
library(mice)
library(readr)
library(skimr)
library(ggplot2)
library(tidyverse)
library(reshape2)
library(MASS)
library(forecast)
library(kableExtra)
library(ggpubr)
library(fastDummies)

## To load the below libraries you might have to do the following in the console first:
####  install.packages("devtools")
####  devtools::install_github("haleyjeppson/ggmosaic")
####  devtools::install_github("thomasp85/patchwork")

library(ggmosaic)
library(patchwork)

library(caTools)
library(corrplot)
library(Hmisc)

knitr::opts_chunk$set(echo = FALSE)
```


```{r data}
# read train and evaluation datasets
train_df <- read.csv("https://raw.githubusercontent.com/cliftonleesps/data621_group1/main/hw4/insurance_training_data.csv")
eval_df <- read.csv("https://raw.githubusercontent.com/cliftonleesps/data621_group1/main/hw4/insurance-evaluation-data.csv")

```



Clean up data
```{r}
train_df <- train_df %>%  dplyr::select(-INDEX)


## Remove z_ from character class values
z_vars <- c("MSTATUS","SEX","JOB","CAR_TYPE","URBANICITY","EDUCATION")
for (v in z_vars) {
  train_df <- train_df %>% mutate(!!v := str_replace(get(v),"z_",""))
}


## Update RED_CAR, replace [no,yes] values with [No, Yes] values
train_df <- train_df %>% mutate( RED_CAR = ifelse(RED_CAR == "no","No","Yes"))

#Inasted of level "" will be "Unknown"
train_df$JOB[train_df$JOB==""] <- "Unknown"


## Convert currency columns from character class to integer
dollar_vars <- c("INCOME","HOME_VAL","BLUEBOOK","OLDCLAIM")
for (v in dollar_vars) {
  train_df <- train_df %>% mutate(!!v := str_replace(get(v),"[\\$,]",""))
}

currency_vars <- c("INCOME","HOME_VAL","BLUEBOOK","OLDCLAIM")

for (v in currency_vars) {
  train_df <- train_df %>% mutate(!!v := parse_number(get(v)))
}

```




```{r}
set.seed(1233)

sample <- sample.split(train_df$TARGET_FLAG, SplitRatio = 0.8)
train_data  <- subset(train_df, sample == TRUE)
test_data   <- subset(train_df, sample == FALSE)

```




## Overview

In this homework assignment, we will explore, analyze and model a data set containing approximately 8000 records representing a customer at an auto insurance company. We will build multiple linear regression on the continuous variable `TARGET_AMT` and binary logistic regression on the `TARGET_FLAG` using the training data to predict the probability that a person will crash their car and also the amount of money it will cost if the person does crash their car. 

We are going to build several models using different techniques and variable selection. In order to best assess our predictive model, we created a test set within our training data, and split it along an 80/20 training/testing proportion, before applying the finalized models to a separate evaluation dataset that did not contain the target.


## 1. Data Exploration

The insurance training dataset contains 8161 observations of 26 variables, each record represents a customer at an auto insurance company. The evaluation dataset contains 2141 observations of 26 variables.
The descriptions of each column are below.

Each record has two response variables. The first response variable, `TARGET_FLAG`, is a 1 or a 0. A “1” means that the person was in a car crash. A zero means that the person was not in a car crash. The second response variable is `TARGET_AMT`. This value is zero if the person did not crash their car. But if they did crash their car, this number will be a value greater than zero.


<img src="https://raw.githubusercontent.com/cliftonleesps/data621_group1/main/hw4/hw4_variables.png" width="1200" style="display: block; margin-left: auto; margin-right: auto; width: 100%;"/>

### 1.1 Summary Statistics

The training data can be previewed below. The `TARGET_FLAG` column is the binary dependent variable denoting if a car was in a crash (target = 1) or not (target = 0).
`TARGET_AMT` is a numeric dependent variable and represents the amount of time the car spent on repairs in case of crash. The minimum is 0 (car wasn't in crash, no time spent on repairs), the maximum is 107586.1. 
```{r summary1}
DT::datatable(
      train_df[1:500,],
      extensions = c('Scroller'),
      options = list(scrollY = 350,
                     scrollX = 500,
                     deferRender = TRUE,
                     scroller = TRUE,
                     dom = 'lBfrtip',
                     fixedColumns = TRUE, 
                     searching = FALSE), 
      rownames = FALSE) 
```

The table below provides valuable descriptive statistics about the training data. 14 variables are categorical, 12 variables are numeric.
There is no missing data for categorical variables while numeric variables `YOJ` (years on job) has 5% of missing data, `CAR_AGE` (vehicle age) has 6%, and `AGE` (age of driver) has less than 1%. 
Most of the numeric variables have a minimum of zero. Some numbers seem strange, we should deal with it later. For example, `CAR_AGE` has the minimum value of -3.
Some of the variables are character though they should be numeric and vice versa. Variable `OLDCLAIM`, `BLUEBOOK`, `HOME_VAL`, `INCOME` have $ sign in front a number, we should remove the sign and transform the variable to numeric. Variables `MSTATUS` (Marital Status), `EDUCATION`, `JOB`, `CAR_TYPE`, `SEX` AND `URBANICITY` contain prefix `z_` that should be removed as well.
**ADD SOMETHING ELSE FOR SUMMARY**

```{r summary}
skim_without_charts(train_df)
```




### 1.2 Distributions

Before building a model, we need to make sure that we have both classes equally presented in out `TARGET_FLAG` variable. Class `1` takes 27% and class `0` takes 63% of the target variable. As a result, we have unbalanced class distribution for our target variable that we have to deal with, we have to take some additional steps (bootstrapping, etc) before using logistic regression.
```{r balance}
prop.table(table(train_df$TARGET_FLAG)) %>% kable(label = "Distribution of Target Flag", caption = "Distribution of Target Flag", col.names = c("Value", "%"), digits = 2) %>% 
    kable_styling(full_width = F) 
```

The distribution of the second target variable `TARGET_AMT` is right skewed, we will also transform the variable to make it follow the normal distribution (log/BoxCox).


```{r}

m_df <- train_df %>% dplyr::select(where(is.numeric)) %>%
  pivot_longer(!c(TARGET_FLAG,TARGET_AMT), names_to='variable' , values_to = 'value') %>% drop_na()

m_df %>% ggplot(aes(x=value, group=TARGET_FLAG, fill=TARGET_FLAG)) + 
geom_density(color='#023020') + facet_wrap(~variable, scales = 'free',  ncol = 4) + theme_bw()


```


### 1.3 Box Plots

```{r}

m_df %>% ggplot(aes(x=value, group=TARGET_FLAG, fill=TARGET_FLAG)) + 
geom_boxplot(color='#023020') + facet_wrap(~variable, scales = 'free',  ncol = 4) + theme_bw()

```


### 1.4 Scatter Plot

```{r}

m_df %>% drop_na() %>% ggplot(aes(x=value, y=TARGET_AMT)) + 
geom_smooth(method='glm', se=TRUE, na.rm=TRUE) +
geom_point(color='#023020') + facet_wrap(~variable, scales = 'free',  ncol = 4) + theme_bw()

```


### 1.5 Correlation Matrix

```{r corr}

rcore <- rcorr(as.matrix(train_df %>% dplyr::select(where(is.numeric))))
coeff <- rcore$r
corrplot(coeff, tl.cex = .5, tl.col="black", method = 'color', addCoef.col = "black",
         type="upper", order="hclust",
         diag=FALSE)

```


## 2. Data preparation

### 2.1 Data type
First, we will remove prefixes `z_` and `$` together with the `INDEX` variable (identification Variable), transform to factor variables `TARGET_FLAG`, `KIDSDRIV`, `HOMEKIDS`, `CLM_FREQ`, `MVR_PTS`. Also, we transform to numeric variables `INCOME`, `HOME_VAL`, `BLUEBOOK`, `OLDCLAIM`.

As we see below,  there are no unwanted characters in the factor variables. The `JOB` variable contains empty level `""`, it was substituted with `"Unknown"`. `RED_CAR` levels will be "Yes/No" instead of "yes/no".


**ADDED DUMMY VARS, NOT SURE IF WE NEED THEM**

```{r}
# train_df <- train_df %>%  dplyr::select(-INDEX)
# 
# 
# ## Remove z_ from character class values
# z_vars <- c("MSTATUS","SEX","JOB","CAR_TYPE","URBANICITY","EDUCATION")
# for (v in z_vars) {
#   train_df <- train_df %>% mutate(!!v := str_replace(get(v),"z_",""))
# }
# 
# 
# ## Update RED_CAR, replace [no,yes] values with [No, Yes] values
# train_df <- train_df %>% mutate( RED_CAR = ifelse(RED_CAR == "no","No","Yes"))
# 
# #Inasted of level "" will be "Unknown"
# train_df$JOB[train_df$JOB==""] <- "Unknown"
# 
# 
# 
# ## Convert currency columns from character class to integer
# dollar_vars <- c("INCOME","HOME_VAL","BLUEBOOK","OLDCLAIM")
# for (v in dollar_vars) {
#   train_df <- train_df %>% mutate(!!v := str_replace(get(v),"[\\$,]",""))
# }
# 
# currency_vars <- c("INCOME","HOME_VAL","BLUEBOOK","OLDCLAIM")
# 
# for (v in currency_vars) {
#   train_df <- train_df %>% mutate(!!v := parse_number(get(v)))
# }


## Convert the below character variables to factors
factor_vars <- c("TARGET_FLAG", "KIDSDRIV","HOMEKIDS","CLM_FREQ", "MVR_PTS", "PARENT1","CAR_TYPE","JOB","CAR_USE","URBANICITY","RED_CAR","REVOKED","MSTATUS","EDUCATION","SEX")

for (v in factor_vars) {
  train_df <- train_df %>% mutate(!!v := factor(get(v)))
}
```


```{r}

for (i in factor_vars) {
  print(lapply(train_df[i], levels))
}

```

### 2.3 Outliers

There is `CAR_AGE`< 0, we can substitute it with NAs.

```{r}


## We have one row with a car age < 0! just set it to zero. Assume it's a brand new car
### train_df <- rows_update(train_df, tibble(INDEX = 8772, CAR_AGE = 0))
```


### 2.3 Missing values, transformations
Since variables `AGE`, `YOJ`, `CAR_AGE`, `INCOME` and `HOME_VALWe` have missing values, we are going to use function mice() to impute these variables.
```{r impute}

## We need to impute the AGE, YOJ, CAR_AGE, INCOME and HOME_VAL variables
imputed_Data <- mice(train_df, m=5, maxit = 20, method = 'pmm', seed = 500, printFlag=FALSE)
transformed_df <- complete(imputed_Data)

```


Log transformation will be applied to variables `INCOME`, `TARGET_AMT`, `OLDCLAIM` to transform their distributions from right-skewed to he normal.
BoxCox transformation will be applied to variables `BLUEBOOK`, `TRAVTIME`, `TIF`, so they follow the normal distribution.


```{r boxcox, fig.keep="none"}

## Use basic log transformation on `TARGET_AMT`, `OLDCLAIM`, `INCOME`
transformed_df$TARGET_AMT <- log(transformed_df$TARGET_AMT)
transformed_df$OLDCLAIM <- log(transformed_df$OLDCLAIM)
#transformed_df$INCOME <-  log(transformed_df$transformed_df$INCOME)


# use Box-Cox on `BLUEBOOK`, `TRAVTIME`,  `TIF`

bluebook_boxcox <- boxcox(lm(transformed_df$BLUEBOOK ~ 1))
bluebook_lambda <- bluebook_boxcox$x[which.max(bluebook_boxcox$y)]
bluebook_trans <- BoxCox(transformed_df$BLUEBOOK, bluebook_lambda)
transformed_df$BLUEBOOK <- bluebook_trans

travtime_boxcox <- boxcox(lm(transformed_df$TRAVTIME ~ 1))
travtime_lambda <- travtime_boxcox$x[which.max(travtime_boxcox$y)]
travtime_trans <- BoxCox(transformed_df$TRAVTIME, travtime_lambda)
transformed_df$TRAVTIME <- travtime_trans

tif_boxcox <- boxcox(lm(transformed_df$TIF ~ 1))
tif_lambda <- tif_boxcox$x[which.max(tif_boxcox$y)]
tif_trans <- BoxCox(transformed_df$TIF, tif_lambda)
transformed_df$TIF <- tif_trans


## Create CAR_CRASH variable from the target flag for later exploration
transformed_df <- transformed_df %>% mutate(CAR_CRASH = ifelse(TARGET_FLAG == 1, 'Yes', 'No'))

## put into bins:  TIF; CAR_AGE; HOMEKIDS; HOME_VAL
q <- quantile(transformed_df$CAR_AGE)
q <- c(-1,  1,  8, 12, 28)
transformed_df <- transformed_df %>% mutate(CAR_AGE_BIN = cut(CAR_AGE, breaks=q, labels=FALSE))

q <- quantile(transformed_df$HOME_VAL)
q[1] <- -1
transformed_df <- transformed_df %>% mutate(HOME_VAL_BIN = cut(HOME_VAL, breaks=q, labels=FALSE))

q <- quantile(transformed_df$TIF); 
q[1] <- -1
transformed_df <- transformed_df %>% mutate(TIF_BIN = cut(TIF, breaks=q, labels=FALSE))


print(summary(transformed_df))


```


**WE NEED TO ADD DUMMY VARS FOR SOME FACTORS, RIGHT?**

```{r dummy_vars}
dummy_vars <- function(df){
  df %>%
    mutate(
      MALE <- factor(ifelse(SEX=="M", 1, 0)), 
      MARRIED <- factor(ifelse(MSTATUS=="Yes", 1, 0)),
      ANNUL <- factor(ifelse(REVOKED =="Yes", 1, 0)),
      RED <- factor(ifelse(RED_CAR =="Yes", 1, 0)),
      PRIVATE <- factor(ifelse(CAR_USE =="Private", 1, 0)),
      SINGLE_PARENT <- factor(ifelse(PARENT1 =="Yes", 1, 0)),
      URBAN <- factor(ifelse(URBANICITY =="Highly Urban/ Urban", 1, 0))
    ) %>% 
    dplyr::select(-c(SEX, MSTATUS, REVOKED, RED_CAR, CAR_USE, PARENT1,URBANICITY))
  
      }

dummy_df <- dummy_vars(transformed_df)
```


```{r}
#dummy_df <- dummy_cols(dummy_df, select_columns = 'EDUCATION')
```



### 2.4 Visualizations

```{r visualizations}
colnames(transformed_df)

a <- transformed_df %>% select_if(is.numeric) %>% dplyr::select(!(c(TARGET_AMT))) %>% data.table::melt()
a %>% ggplot(aes(x=value))+ geom_density(alpha=.2,fill="#FF6666") + facet_wrap(~variable, scales='free')


## Mosaic plots to view any relationship to the TARGET_FLAG variable for binary factor variables
## PARENT1
plot_parent1 <- ggplot(data = transformed_df) +
  geom_mosaic(aes(x = PARENT1, fill=CAR_CRASH), offset = 0.005) +
  labs(y="", x="", title="Single Parent", margin=margin(b=10,unit="pt")) +
    theme(panel.background = element_blank(),
          axis.text.y = element_blank(),
          axis.ticks.y= element_blank(),
          axis.ticks.x= element_blank(),
          axis.text.x = element_text(angle = 0, margin = margin(t = -6, unit="mm")),
          plot.title = element_text(hjust = 0.5),
          axis.title.x = element_blank(),
          legend.position = "right")

## Sex
plot_sex <- ggplot(data = transformed_df) +
  geom_mosaic(aes(x = SEX, fill=CAR_CRASH), offset = 0.005) +
  labs(y="", x="", title="Sex", margin=margin(b=10,unit="pt")) +
    theme(panel.background = element_blank(),
          axis.text.y = element_blank(),
          axis.ticks.y= element_blank(),
          axis.ticks.x= element_blank(),
          axis.text.x = element_text(angle = 0, margin = margin(t = -6, unit="mm")),
          plot.title = element_text(hjust = 0.5),
          axis.title.x = element_blank(),
          legend.position = "right")

## Marriage status
plot_mstatus <- ggplot(data = transformed_df) +
  geom_mosaic(aes(x = MSTATUS, fill=CAR_CRASH), offset = 0.005) +
  labs(y="", x="", title="Marriage Status", margin=margin(b=10,unit="pt")) +
    theme(panel.background = element_blank(),
          axis.text.y = element_blank(),
          axis.ticks.y= element_blank(),
          axis.ticks.x= element_blank(),
          axis.text.x = element_text(angle = 0, margin = margin(t = -6, unit="mm")),
          plot.title = element_text(hjust = 0.5),
          axis.title.x = element_blank(),
          legend.position = "right")

## Car use
plot_car_use <- ggplot(data = transformed_df) +
  geom_mosaic(aes(x = CAR_USE, fill=CAR_CRASH), offset = 0.005) +
  labs(y="", x="", title="Car Use", margin=margin(b=10,unit="pt")) +
    theme(panel.background = element_blank(),
          axis.text.y = element_blank(),
          axis.ticks.y= element_blank(),
          axis.ticks.x= element_blank(),
          axis.text.x = element_text(angle = 0, margin = margin(t = -6, unit="mm")),
          plot.title = element_text(hjust = 0.5),
          axis.title.x = element_blank(),
          legend.position = "right")

## Red car
plot_red_car <- ggplot(data = transformed_df) +
  geom_mosaic(aes(x = RED_CAR, fill=CAR_CRASH), offset = 0.005) +
  labs(y="", x="", title="Red Car?", margin=margin(b=10,unit="pt")) +
    theme(panel.background = element_blank(),
          axis.text.y = element_blank(),
          axis.ticks.y= element_blank(),
          axis.ticks.x= element_blank(),
          axis.text.x = element_text(angle = 0, margin = margin(t = -6, unit="mm")),
          plot.title = element_text(hjust = 0.5),
          axis.title.x = element_blank(),
          legend.position = "right")

## license revoked
plot_revoked <- ggplot(data = transformed_df) +
  geom_mosaic(aes(x = REVOKED, fill=CAR_CRASH), offset = 0.005) +
  labs(y="", x="", title="License Revoked (Past 7 Years)", margin=margin(b=10,unit="pt")) +
    theme(panel.background = element_blank(),
          axis.text.y = element_blank(),
          axis.ticks.y= element_blank(),
          axis.ticks.x= element_blank(),
          axis.text.x = element_text(angle = 0, margin = margin(t = -6, unit="mm")),
          plot.title = element_text(hjust = 0.5),
          axis.title.x = element_blank(),
          legend.position = "right")

## urban or rural area
plot_urbanicity <- ggplot(data = transformed_df) +
  geom_mosaic(aes(x = URBANICITY, fill=CAR_CRASH), offset = 0.005) +
  labs(y="", x="", title="Home / Work Area", margin=margin(b=10,unit="pt")) +
    theme(panel.background = element_blank(),
          axis.text.y = element_blank(),
          axis.ticks.y= element_blank(),
          axis.ticks.x= element_blank(),
          axis.text.x = element_text(angle = 0, margin = margin(t = -6, unit="mm")),
          plot.title = element_text(hjust = 0.5),
          axis.title.x = element_blank(),
          legend.position = "right")

plot_parent1 + plot_sex + plot_mstatus + plot_car_use + plot_red_car + plot_revoked + plot_urbanicity + plot_layout(nrow = 4)


## Mosaic plots to view any relationship to the TARGET_FLAG variable for multi-level factors 
plot_education <- ggplot(data = transformed_df) +
  geom_mosaic(aes(x = EDUCATION, fill=CAR_CRASH), offset = 0.005) +
  labs(y="", x="", title="Education", margin=margin(b=10,unit="pt")) +
    theme(panel.background = element_blank(),
          axis.text.y = element_blank(),
          axis.ticks.y= element_blank(),
          axis.ticks.x= element_blank(),
          axis.text.x = element_text(angle = 90, margin = margin(t = -0.5, unit="pt")),
          plot.title = element_text(hjust = 0.5),
          axis.title.x = element_blank(),
          legend.position = "right")

plot_job <- ggplot(data = transformed_df) +
  geom_mosaic(aes(x = JOB, fill=CAR_CRASH), offset = 0.005) +
  labs(y="", x="", title="Job Category", margin=margin(b=10,unit="pt")) +
    theme(panel.background = element_blank(),
          axis.text.y = element_blank(),
          axis.ticks.y= element_blank(),
          axis.ticks.x= element_blank(),
          axis.text.x = element_text(angle = 90, margin = margin(t = -0.5, unit="pt")),
          plot.title = element_text(hjust = 0.5),
          axis.title.x = element_blank(),
          legend.position = "right")

plot_car_type <- ggplot(data = transformed_df) +
  geom_mosaic(aes(x = CAR_TYPE, fill=CAR_CRASH), offset = 0.005) +
  labs(y="", x="", title="Car Type", margin=margin(b=10,unit="pt")) +
    theme(panel.background = element_blank(),
          axis.text.y = element_blank(),
          axis.ticks.y= element_blank(),
          axis.ticks.x= element_blank(),
          axis.text.x = element_text(angle = 90, margin = margin(t = -0.5, unit="pt")),
          plot.title = element_text(hjust = 0.5),
          axis.title.x = element_blank(),
          legend.position = "right")


plot_education + plot_job + plot_car_type + plot_layout(nrow = 2)

```

## 3. Multiple linear regression


### 3.1 Model 1 - 


### 3.2 Model 2 - 


### 3.3 Model 3 - 

### 3.4 Model selection



## 4. Binary logistic regression


### 4.1 Model 1 - 


### 4.2 Model 2 - 


### 4.3 Model 3 - 

### 4.4 Model selection



## 5. Predictions


## 6. Conclusion



## 7. References


## Appendix: R code


