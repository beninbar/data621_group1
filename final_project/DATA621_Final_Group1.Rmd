---
title: 'Final: Texas Higher Education Opportunity Project (THEOP)'
subtitle: 'Critical Thinking Group 1'
author: 'Ben Inbar, Cliff Lee, Daria Dubovskaia, David Simbandumwe, Jeff Parks'
output:
  html_document:
    toc: yes
    toc_float: yes
    theme: united
  pdf_document:
    toc: yes
editor_options:
  chunk_output_type: console
  markdown: 
    wrap: sentence
---

```{r setup, include=FALSE}
# chunks
knitr::opts_chunk$set(echo=FALSE, eval=TRUE, include=TRUE, 
message=FALSE, warning=FALSE, fig.height=5, fig.align='center')

# libraries
library(tidyverse)
library(kableExtra)
library(MASS) # glm.nb()
library(mice)
library(pscl) # zeroinfl()
library(skimr)
library(sjPlot)
library(mpath)
library(yardstick)
library(labelled)
library(haven)
library(corrplot)
library(Hmisc)
library(janitor)
library(reshape)
library(ggpubr)
library(ggplot2)

# ggplot
theme_set(theme_light())


# random seed
set.seed(42)
```

```{r common functions}

nice_table <- function(df){
  table <- df %>% kable %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                html_font = 'monospace',
                full_width = FALSE)
  return(table)
}

model_diag <- function(model){
  model_sum <- summary(model)
  aic <- AIC(model)
  ar2 <- model_sum$adj.r.squared
  disp <- sum(resid(model,'pearson')^2)/model$df.residual
  loglik <- logLik(model)
  
  vec <- c(ifelse(is.null(aic), NA, aic),
           ifelse(is.null(ar2), NA, ar2),
           ifelse(is.null(disp), NA, disp),
           ifelse(is.null(loglik), NA, loglik))
  
  names(vec) <- c('AIC','Adj R2','Dispersion','Log-Lik')
  return(vec)
}

factor_haven <- function(df, col_lst) {
  for (c in col_lst) {
    df[c] <- as_factor(zap_missing(df[c]))
  }
  return(df)
}

```

# Abstract 

<i>Use 250 words or less to summarize your problem, methodology, and major outcomes</i>


# Introduction

Despite some claims, people have acknowledged a gap in access to higher education still exists, especially for minority students. However, many have objected to affirmative action policies as a solution, and in 1996 in Texas, the Fifth Court Circuit of Appeals outlawed the use of race for college admissions in the state. After a noticeable drop in minority student enrollments, the governor of Texas signed a new bill as a compromise:  any high school student finishing in top decile received a guaranteed admission to Texas’ two flagship public universities (University of Texas at Austin and Texas A&M University). Instead of competing with applicants from the entire state, students only had to compete with their immediate classmates to access higher education.

# Literature review
<i>Discuss how other researchers have addressed similar problems, what their achievements are, and what the advantage and drawbacks of each reviewed approach are. Explain how your investigation is similar or different to the state-of-the-art. Please cite the relevant papers where appropriate. </i>

# Methodology 
<i>Discuss the key aspects of your problem, data set and regression model(s). Given that you are working on real-world data, explain at a high-level your exploratory data analysis, how you prepared the data for regression modeling, your process for building regression models, and your model selection.</i> 




# Load Data

```{r}

# change to your local data dir outside the repo
local_data_dir <- '../../data/theop'
# 
# 
# # load application and transactions data frames
load(paste0(local_data_dir, '/data_model/df_applications.RData'))
load(paste0(local_data_dir, '/data_model/df_transcripts.RData'))
# 
# load("C:\\Users\\bpinb\\OneDrive\\Desktop\\Coursework\\DATA 621 Business Analytics and Data Mining\\Final project\\Data\\theop\\theop\\data_model\\df_applications.RData")
# load("C:\\Users\\bpinb\\OneDrive\\Desktop\\Coursework\\DATA 621 Business Analytics and Data Mining\\Final project\\Data\\theop\\theop\\data_model\\df_transcripts.RData")

```

```{r}
# clean application data and remove labels
app_df  <- df_applications

col_lst <- c("termdes","male","ethnic","citizenship","restype","satR","actR","testscoreR","decileR","quartile","major_field","hsprivate","hstypeR","hsinstate","hseconstatus","hslos","hscentury","admit","admit_prov","enroll","gradyear","studentid_uniq","univ","termapp","sat_not_recenteredR","admit_ut_summer")

app_df <- factor_haven(app_df,col_lst)

# clean transcripts and remove labels
transcript_df <- df_transcripts

col_lst <- c("term","semgpa","hrearn","term_major_dept","term_major_field")

transcript_df <- factor_haven(transcript_df,col_lst)

```

```{r}
#rm(df_transcripts, df_applications)
```

```{r distrib}

transcript_df %>% dplyr::select(where(is.numeric)) %>%
  #dplyr::select(!target) %>%
  pivot_longer(everything(),names_to = c('variables'),values_to = c('values')) %>% 
  ggplot() +
  geom_histogram(aes(x=values, y = ..density..), alpha=0.5, colour='black', linewidth=0.2) +
  #geom_density(aes(x=values), color='purple') +
  facet_wrap(vars(variables), scales="free")

```

```{r}

rcore <- rcorr(as.matrix(transcript_df %>% dplyr::select(where(is.numeric))))

coeff <- rcore$r

corrplot(coeff, tl.cex = .5, tl.col="black", method = 'color', addCoef.col = "black",type="upper", order="hclust", number.cex=0.7, diag=FALSE)

```



Choose Texas A&M college and compare the admissions policy at a university before and after top 10%. Make variables categorical if needed.

```{r}
texas_applications <- filter(df_applications, univ == "am") %>% dplyr::select(!c(termapp, sat_not_recenteredR, admit_ut_summer, univ))
texas_transcripts <- filter(df_transcripts, univ == "am") %>% dplyr::select(!univ)
```

```{r}
factor_vars_1 <- c("termdes","male","ethnic","citizenship","restype","decileR","quartile",
                 "major_field","hsprivate","hstypeR","hsinstate","hseconstatus","admit","admit_prov","enroll")

for (v in factor_vars_1) {
  texas_applications <- texas_applications %>% mutate(!!v := factor(get(v)))
}

factor_vars_2 <- c("term","term_major_dept","term_major_field")

for (v in factor_vars_2) {
  texas_transcripts <- texas_transcripts %>% mutate(!!v := factor(get(v)))
}
```



# Data Exploration

The **application** dataset contained 163,027 observations of 24 predictor variables and **transcripts** dataset contained 637,028 observations of 10 predictor variables, where each record represented an individual applicant.
These variables describe items typically found on a college admission application such as the year and term an applicant desired to enroll, applicant 
demographics, applicant academic characteristics, and high school characteristics.



<img src="https://raw.githubusercontent.com/cliftonleesps/data621_group1/main/final_project/project_data.png" width="1200" style="display: block; margin-left: auto; margin-right: auto; width: 100%;"/>

### 1.1 Summary Statistics

Each record in the application dataset included a response variable "admit" (Institution’s admission decision), was a boolean where "1" indicated the person was admitted.
Each record in the transcript dataset registers academic progress toward a degree for a single enrollee in a single semester (hours earned, semester GPA, cumulative GPA, and department and field of major).

A sample of the data appears in the following tables:

```{r}
DT::datatable(
      texas_applications[1:25,],
      extensions = c('Scroller'),
      options = list(scrollY = 350,
                     scrollX = 500,
                     deferRender = TRUE,
                     scroller = TRUE,
                     dom = 'lBfrtip',
                     fixedColumns = TRUE, 
                     searching = FALSE), 
      rownames = FALSE) 
```


```{r}
DT::datatable(
      texas_transcripts[1:25,],
      extensions = c('Scroller'),
      options = list(scrollY = 350,
                     scrollX = 500,
                     deferRender = TRUE,
                     scroller = TRUE,
                     dom = 'lBfrtip',
                     fixedColumns = TRUE, 
                     searching = FALSE), 
      rownames = FALSE) 
```


While exploring this data, we made the following observations for the **applications data**:

-   21 variables were categorical, and 3 were numeric.
-   `actR`, `gradyear`, `hscentury`, `hslos` variables had more that 50% of the missing data.

For the **transcripts data**:

-  no missing values besides `cgpa` had only 64 missing values out of 637,028 observations.
-  6 variables were categorical, and 4 were numeric.


```{r}

texas_applications %>% 
  #dplyr::select(!c(source, target)) %>%
  skim() %>%
  dplyr::select(skim_variable, complete_rate, n_missing, 
                numeric.p0, numeric.p100) %>%
  dplyr::rename(variable=skim_variable, min=numeric.p0, max=numeric.p100) %>%
  mutate(complete_rate=round(complete_rate,2), 
         min=round(min,2), max=round(max,2)) %>%
  arrange(variable) %>%
  nice_table()
```

```{r}

texas_transcripts %>% 
  #dplyr::select(!c(source, target)) %>%
  skim() %>%
  dplyr::select(skim_variable, complete_rate, n_missing, 
                numeric.p0, numeric.p100) %>%
  dplyr::rename(variable=skim_variable, min=numeric.p0, max=numeric.p100) %>%
  mutate(complete_rate=round(complete_rate,2), 
         min=round(min,2), max=round(max,2)) %>%
  arrange(variable) %>%
  nice_table()

```

### 1.2 Distribution

76% of all the students were admitted to the university.
```{r}
texas_applications%>%
  ggplot() +
  geom_bar(aes(x=admit), colour='black', size=0.2) 
```

By checking the frequency of the variables with few unique values ("male","ethnic", "citizenship", "restype","decileR","major_field"), we checked the frequency of each value.
As demonstrated by the graph below, more than 50% of the data for the `citizenship`, `restype` and `ethnic` variables was `US Citizen`, `Texas Resident` and `White, Non-Hispanic` accordingly:

```{r discrete_plot}
texas_applications[,c("male","ethnic", "citizenship", "restype","decileR","major_field")] %>%
  gather("variable","value") %>%
  group_by(variable) %>%
  count(value) %>%
  mutate(value = factor(value,levels=8:0)) %>%
  mutate(percent = n*100/163027) %>%
  ggplot(.,
  aes(variable,percent)) +
  geom_bar(stat = "identity", aes(fill = value)) +
  xlab("Variable") +
  ylab("Percentage") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_fill_manual(values = rev(c("#003f5c","#58508d", "#bc5090", "#ff6361", "#ffa600","#CC79a7", "black", "green", "blue")))
```

```{r}
a <- ggplot(texas_transcripts, aes(x = cgpa)) +
  geom_histogram(binwidth = 1, fill = "skyblue", color = "black") +
  labs(x = "Per semester cumulative gpa", y = "Count")


b <- ggplot(texas_transcripts, aes(x = semgpa)) +
  geom_histogram(binwidth = 1, fill = "skyblue", color = "black") +
  labs(x = "Semester gpa", y = "Count")

plot<- ggarrange(a, b, ncol=2, nrow=1)

annotate_figure(plot, top = text_grob("Distribution of GPA", 
               color = "black", face = "bold", size = 14))
```

```{r}
m_df <- texas_applications %>% dplyr::select(c(satR, actR, testscoreR)) %>% melt() 

m_df %>% ggplot(aes(x= value)) + 
geom_histogram(color='#023020', fill='gray') + 
  facet_wrap(~variable, scales = 'free',  ncol = 4) + theme_bw()

```


```{r}
m_df <- texas_transcripts %>% dplyr::select(c(semgpa,cgpa)) %>% melt() 

m_df %>% ggplot(aes(x= value)) + 
geom_histogram(color='#023020', fill='gray') + 
  facet_wrap(~variable, scales = 'free',  ncol = 4) + theme_bw()

```

### 1.3 Boxplots



# Transform Data


```{r}
#maybe split data by year: before 1998 and after

appl_1997 <- filter(texas_applications, yeardes < 1998)
appl_1998 <- filter(texas_applications, yeardes >= 1998)

transc_1997 <- filter(texas_transcripts, year < 1998)
transc_1998 <- filter(texas_transcripts, year >= 1998)
```


```{r}
t_df <- transcript_df

t_df$term_num <- as.numeric(t_df$term)
#t_df <- t_df %>% mutate(id = id + 1)
t_df$term_num = t_df$term_num + 1
t_df$term_num[t_df$term_num == 2] <- 1
t_df$term_num[t_df$term_num == 6] <- 2
t_df$term_num[t_df$term_num == 7] <- 6
t_df$term_num = t_df$term_num / 10
t_df$term_num = t_df$year + t_df$term_num
```


```{r}
avg_df <- t_df %>%
  group_by(studentid) %>%
  summarise(avg_gpa = mean(cgpa)
 )

first_df <- t_df %>%
  group_by(studentid) %>%
  slice(which.min(term_num))
  
last_df <- t_df %>%
  group_by(studentid) %>%
  slice(which.max(term_num))

merge_df <- merge(avg_df, first_df, by='studentid')


merge_df <- merge(merge_df, last_df, by='studentid', 
                  suffixes = c(".first",".last"))


merge_df <- merge(merge_df, app_df, by='studentid')



model_df <- merge_df %>% 
  dplyr::select('avg_gpa','male','ethnic','citizenship','restype','satR','testscoreR','decileR')
 
levels(model_df$citizenship) <- c(levels(model_df$citizenship),"None")
model_df$citizenship[is.na(model_df$citizenship)] <- "None"
levels(model_df$ethnic) <- c(levels(model_df$ethnic),"None")
model_df$ethnic[is.na(model_df$ethnic)] <- "None"
levels(model_df$restype) <- c(levels(model_df$restype),"None")
model_df$restype[is.na(model_df$restype)] <- "None"
levels(model_df$male) <- c(levels(model_df$male),"None")
model_df$male[is.na(model_df$male)] <- "None"

# set values
model_df$decileTop10 <- FALSE
model_df$decileTop10[as.numeric(model_df$decileR) == 1] <- TRUE
levels(model_df$decileR) <- c(levels(model_df$decileR),"None")
model_df$decileR[is.na(model_df$decileR)] <- "None"

```

```{r}

model_df %>% 
  #dplyr::select(!c(source, target)) %>%
  skim() %>%
  dplyr::select(skim_variable, complete_rate, n_missing, 
                numeric.p0, numeric.p100) %>%
  dplyr::rename(variable=skim_variable, min=numeric.p0, 
                max=numeric.p100) %>%
  mutate(complete_rate=round(complete_rate,2), 
         min=round(min,2), max=round(max,2)) %>%
  arrange(variable) %>%
  nice_table()

```

```{r}
rcore <- rcorr(as.matrix(merge_df %>% dplyr::select(!c('year.first','year.last')) %>% dplyr::select(where(is.numeric))))

coeff <- rcore$r

corrplot(coeff, tl.cex = .8, tl.col="black", method = 'color', addCoef.col = "black", type="upper", order="hclust", number.cex=0.7, diag=FALSE)

```

### Merge dataframes.

Check for duplicates in applications and transcripts.
For applications there were duplicates for the desired year of admission, so we took the minimum desired year.
For transcripts, make sure there are no duplicates for the same semester.
We also limited to enrollment at the applied school to track progress only at schools of enrollment.

```{r}
tabyl(app_df$termdes)
#dupes <- get_dupes(app_df, studentid_uniq, enroll)

app_df <- app_df |>
  mutate(termdes_num = case_when(termdes=='Spring' ~ 1
                                 , termdes=='Summer I' ~ 2
                                 , termdes=='Summer II' ~ 3
                                 , termdes=='Fall' ~ 4)) |>
  group_by(studentid_uniq) |>
  filter(yeardes==min(yeardes)) |>
  filter(termdes_num==min(termdes_num)) |>
  filter(enroll=="Yes") |>
  ungroup()
  
#dupes <- get_dupes(transcript_df, studentid_uniq, year, term)

transcript_df <- transcript_df |>
  distinct()

# Join them together
all <- app_df |>
  left_join(transcript_df, by=c('studentid_uniq', 'univ'))
  
# tabyl(all$ethnic)
# tabyl(all$univ.x)
# tabyl(all$decileR)
# tabyl(all$gradyear)
# table(all$univ.y, all$admit)
# table(all$univ.x, all$univ.y)
# tabyl(all$admit_prov)
# tabyl(all$year)

rm(transcript_df, app_df)

```

### Cleaning

Since the goal was to determine whether the 10% rule was predictive of retention (total number of semesters), and performance (cumulative GPA), to make this easier we widened the data and removed the semester-based tabulation in favor of cumulative.

1.  Create cumulative fields for `hrearn` and total numbers of semesters.
2.  Drop `gpahrs` since this was only available for one school, Texas A&M Kingsville.
3.  Drop several other variables:
    -   `studentid` since we generated a unique id with studentid and school abbreviation.
    -   `yeardes` year of admission desired, since intuitively this would be very hard to interpret as a predictor.
    -   `satR` and `actR` since these were already coalesced in the `testscoreR` column.
    -   `termapp` application term since we wanted to be timing-agnostic.
    -   `termdes_num` since we already had the variable represented as `termdes`
    -   `semgpa` semester by semester GPA, but we were only interested in cumulative.
    -   `gradyear` year of graduation as again, we wanted to be timing-agnostic.

```{r}

cleaned <- all |>
  dplyr::select(-c(studentid.x, studentid.y, yeardes, gpahrs, satR, actR, termapp, termdes_num, semgpa)) |>
  distinct() |>
  mutate(termnum = case_when(term=='Spring' ~ 1
                                 , term=='Summer I' ~ 2
                                 , term=='Summer II' ~ 3
                                 , term=='Fall' ~ 4)) |>
  group_by(studentid_uniq) |>
  mutate(cum_hrs = sum(as.numeric(hrearn)) - n(),
         cum_terms = n(),
         enrolled_pre_98 = case_when(year<=1998 ~ "Pre"
                            , year>1998 ~ "Post"
                            , T ~ "Unknown")) |>
  filter(year==max(year)) |>    # To get maximum enrollment
  filter(termnum==max(termnum)) |>  # ... and maximum cgpa.
  filter(!(enrolled_pre_98=="Unknown")) |>  # Drop cases without term years as we do not know when this would be as it relates to the TX law.
  ungroup() |>
  dplyr::select(-c(year, term, hrearn, termnum)) |>
  dplyr::select(studentid_uniq, everything())  # Just move studentid_uniq to left index.


skim(cleaned)

cleaned <- as.data.frame(cleaned)
cleaned.m <- melt(cleaned)

cleaned.m %>% ggplot(aes(x=value)) +
  geom_density(color='#023020') +
  facet_wrap(~variable, scales = 'free') +
  theme_bw()

```


# Discussion and Conclusions 

<i>Conclude your findings, limitations, and suggest areas for future work. </i>

```{r}
knitr::knit_exit()
```


